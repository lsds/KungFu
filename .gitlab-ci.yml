# https://docs.gitlab.com/ce/ci/yaml/README.html

image: registry.gitlab.com/lsds-kungfu/image/builder:ubuntu18

stages:
- test
- lint

unit test:
  stage: test

  script:
  - | # C++ test
    ./configure --build-tests
    make
    make test

  - | # Go test
    ./scripts/tests/run-go-tests.sh

integration test:
  stage: test
  script:
  - |
    ./configure --build-tests
    make
  - |
    ./scripts/tests/run-integration-tests.sh

system test:
  stage: test

  before_script:
  - |
    DATA_DIR=$HOME/var/data \
    ./scripts/download-mnist.sh

  script:
  - |
    cmake --version
    pip3 install -vvv -U .
  - |
    ./scripts/tests/run-train-tests.sh

python2 test:
  stage: test

  before_script:
  - apt install -y python python-pip
  - pip install tensorflow
  - |
    DATA_DIR=$HOME/var/data \
    ./scripts/download-mnist.sh

  script:
  - cmake --version
  - which python
  - python --version
  - pip install -vvv -U .
  - |
    PYTHON=$(which python) \
    ./scripts/tests/run-train-tests.sh

format test:
  stage: lint
  image: alpine:3.9

  before_script:
  - apk update
  - apk add git go

  script:
  - gofmt -w .
  # TODO: check cpp and python format
  - git diff --exit-code
